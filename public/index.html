<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EOD Watch ‚Äî Pro UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{--bg:#0e1a24;--panel:#0f1b2b;--border:#1f2937;--text:#cbd5e1;--muted:#94a3b8;--accent:#3b82f6;--good:#4ade80;--bad:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border);background:linear-gradient(#0f1b2b,#0e1a24)}
    input,button{background:#0b1522;border:1px solid #22314a;color:var(--text);border-radius:8px;padding:8px 10px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:white}
    .btn-toggle.active{outline:2px solid var(--accent)}
    .toolbar-sep{width:1px;height:24px;background:var(--border);margin:0 6px}
    main{display:grid;grid-template-columns:1fr 320px;gap:10px;padding:10px;height:calc(100% - 56px)}
    #board{grid-column:1/3;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px}
    #board-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .mini{position:relative;background:#0f1b2b;border:1px solid var(--border);border-radius:8px;height:160px;overflow:hidden}
    .mini .title{position:absolute;left:6px;top:4px;font-size:12px;color:var(--muted)}
    .mini .enlarge{position:absolute;right:4px;top:4px;font-size:12px;padding:2px 6px}
    #chart{background:var(--panel);border:1px solid var(--border);border-radius:10px;min-height:520px;height:520px;width:100%}
    aside{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:10px;overflow:auto}
    h3{margin:.25rem 0 .5rem 0;font-size:13px;color:var(--muted)}
    .list .row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px dashed #20304a}
    .kill{background:transparent;border:none;color:#f87171;cursor:pointer;font-size:16px}
    .status{font:12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1524;border:1px solid #22314a;border-radius:8px;padding:8px;white-space:pre-wrap;min-height:38px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:3px 6px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .chip.good{border-color:#236a4d;color:#9ce8c0}
    .chip.bad{border-color:#632828;color:#f3b0b0}
    .chip.warn{border-color:#5a4517;color:#f6d399}
    /* Modal */
    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.84);z-index:50;align-items:center;justify-content:center}
    #modal .box{position:relative;width:92vw;height:86vh;background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    #modal .close{position:absolute;right:10px;top:8px;z-index:2}
  </style>
</head>
<body>
  <header>
    <input id="ticker" placeholder="AAPL" value="AAPL" />
    <button id="btnLoad" class="primary">Load</button>
    <div class="toolbar-sep"></div>
    <button class="tf btn-toggle" data-tf="4H">4H</button>
    <button class="tf btn-toggle active" data-tf="1D">1D</button>
    <button class="tf btn-toggle" data-tf="1W">1W</button>
    <button class="tf btn-toggle" data-tf="1M">1M</button>
    <div class="toolbar-sep"></div>
    <button id="toolLevel" class="btn-toggle">+ Level</button>
    <button id="toolTrend" class="btn-toggle">+ Trend (2-click)</button>
    <div class="toolbar-sep"></div>
    <button id="toggleEMA" class="btn-toggle">EMA200</button>
    <span id="topStatus" style="margin-left:6px;color:var(--muted)">Ready</span>
  </header>

  <main>
    <!-- 10-chart board -->
    <section id="board">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="color:var(--muted);font-size:13px">BOARD (Top 10)</div>
        <div id="boardHint" style="color:var(--muted);font-size:12px">Click mini to load main ¬∑ ‚§¢ to enlarge</div>
      </div>
      <div id="board-grid"></div>
    </section>

    <!-- main chart -->
    <section id="chart"></section>

    <!-- side panel -->
    <aside>
      <div>
        <h3>Signals</h3>
        <div id="chips" class="chips"></div>
      </div>
      <div>
        <h3>Levels</h3>
        <div id="levels" class="list"></div>
      </div>
      <div>
        <h3>Trendlines</h3>
        <div id="trends" class="list"></div>
      </div>
      <div>
        <h3>Log</h3>
        <div id="log" class="status">‚Äî</div>
      </div>
    </aside>
  </main>

  <!-- fullscreen modal -->
  <div id="modal">
    <div class="box">
      <button class="close">‚úï</button>
      <div id="modalCanvas" style="position:absolute;inset:0"></div>
    </div>
  </div>

<script>
(() => {
  console.log('[EOD] JavaScript LOADED - Version 2.0 - ' + new Date().toISOString());
  console.log('[EOD] LightweightCharts available:', typeof LightweightCharts !== 'undefined');
  
  // --- Config ---
  const API = ''; // same-origin Express proxy. If serving UI elsewhere, set 'http://localhost:3000'
  const DEFAULT_WATCHLIST = ['SPY','QQQ','AAPL','MSFT','NVDA','TSLA','META','AMD','GOOGL','IWM'];

  // --- Shorthands ---
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const log = (m)=>{ $('#log').textContent = m; console.log('[EOD]', m); };
  const chip = (txt, cls)=>{ const d=document.createElement('div'); d.className='chip '+(cls||''); d.textContent=txt; return d; };

  // --- State ---
  let currentSymbol = 'AAPL';
  let currentTF = '1D';
  let dailyBars = [];   // raw daily from /eod
  let tfBars = [];      // current timeframe bars
  let drawingMode = false;
  let drawingTool = null;     // 'level' | 'trendline'
  let trendStart = null;      // {time, price}
  let emaOn = false;

  // Persisted drawings
  function keyLevels(sym, tf) { return `eodwatch:${sym}:${tf}:levels`; }
  function keyTrends(sym, tf) { return `eodwatch:${sym}:${tf}:trends`; }
  function loadLevels(sym, tf){ try { return JSON.parse(localStorage.getItem(keyLevels(sym,tf))||'[]'); } catch { return []; } }
  function loadTrends(sym, tf){ try { return JSON.parse(localStorage.getItem(keyTrends(sym,tf))||'[]'); } catch { return []; } }
  function saveLevels(sym, tf, arr){ localStorage.setItem(keyLevels(sym,tf), JSON.stringify(arr)); }
  function saveTrends(sym, tf, arr){ localStorage.setItem(keyTrends(sym,tf), JSON.stringify(arr)); }

  let levels = [];        // [{id,price,color}]
  let trends = [];        // [{id,startTime,startPrice,endTime,endPrice,color}]
  let priceLines = [];    // live chart price lines
  let trendSeries = [];   // live chart line series

  // --- Chart variables (will be initialized when DOM is ready) ---
  let chart, candle, emaSeries, bbUpperSeries, bbMiddleSeries, bbLowerSeries;

  // --- Chart initialization ---
  function initChart() {
    const chartContainer = $('#chart');
    if (!chartContainer) {
      console.error('[EOD] Chart container not found!');
      return false;
    }
    
    if (typeof LightweightCharts === 'undefined') {
      console.error('[EOD] LightweightCharts library not loaded!');
      log('‚ùå LightweightCharts library failed to load');
      return false;
    }
    
    console.log('[EOD] Chart container dimensions:', chartContainer.offsetWidth, 'x', chartContainer.offsetHeight);
    
    console.log('[EOD] Creating chart...');
    try {
      chart = LightweightCharts.createChart(chartContainer, {
      layout:{ background:{ color:'#0f1b2b' }, textColor:'#cbd5e1' },
      rightPriceScale:{ borderVisible:false },
      timeScale:{ borderColor:'#22314a' },
      grid:{ vertLines:{ color:'#132032' }, horzLines:{ color:'#132032' } },
        autoSize:true
      });
      
      console.log('[EOD] Chart created successfully');
      
      candle = chart.addCandlestickSeries({
        upColor: getComputedStyle(document.documentElement).getPropertyValue('--good').trim() || '#4ade80',
        downColor: getComputedStyle(document.documentElement).getPropertyValue('--bad').trim() || '#ef4444',
        wickUpColor:'#4ade80', wickDownColor:'#ef4444', borderVisible:false
      });
      
      emaSeries = chart.addLineSeries({ color:'#60a5fa', lineWidth:2 });
      bbUpperSeries = chart.addLineSeries({ color:'#6b7280', lineWidth:1 });
      bbMiddleSeries = chart.addLineSeries({ color:'#6b7280', lineWidth:1 });
      bbLowerSeries = chart.addLineSeries({ color:'#6b7280', lineWidth:1 });
      
      console.log('[EOD] Chart series added successfully');
      
      // Set up chart click handler for drawing tools
      if (chart && chart.subscribeClick) {
        chart.subscribeClick((param) => {
        if (!drawingMode || !drawingTool) return;
        const price = candle.coordinateToPrice(param.point.y);
        const time = chart.timeScale().coordinateToTime(param.point.x);
        if (!price || !time) return;
        
        if (drawingTool === 'level') {
          addLevel(price);
          drawingMode = false;
          drawingTool = null;
          $('#toolLevel').classList.remove('active');
          log('‚úÖ Level added at ' + price.toFixed(2));
        } else if (drawingTool === 'trendline') {
          if (!trendStart) {
            trendStart = { time, price };
            log('üìç Trendline start set. Click second point.');
          } else {
            addTrend(trendStart, { time, price });
            trendStart = null;
            drawingMode = false;
            drawingTool = null;
            $('#toolTrend').classList.remove('active');
            log('‚úÖ Trendline added');
          }
        }
      });
      }
      
      console.log('[EOD] Chart initialization complete');
      return true;
      
    } catch (error) {
      console.error('[EOD] Chart initialization failed:', error);
      return false;
    }
  }

  // --- Indicators ---
  function emaFromBars(bars, period=200){
    if (!bars?.length) return [];
    const k = 2/(period+1);
    let e = bars[0].close;
    const out = [{ time: bars[0].time, value: e }];
    for (let i=1;i<bars.length;i++){
      e = bars[i].close*k + e*(1-k);
      out.push({ time: bars[i].time, value: e });
    }
    return out;
  }
  function sma(arr, n){
    const out=[]; let sum=0;
    for (let i=0;i<arr.length;i++){
      sum+=arr[i];
      if(i>=n) sum-=arr[i-n];
      if(i>=n-1) out.push(sum/n);
      else out.push(null);
    }
    return out;
  }
  function bollingerBands(bars, period=20, mult=2){
    const closes = bars.map(b=>b.close);
    const mid = sma(closes, period);
    const outU=[], outM=[], outL=[];
    for (let i=0;i<bars.length;i++){
      const m = mid[i];
      if (m==null){ outU.push(null); outM.push(null); outL.push(null); continue; }
      const win = closes.slice(Math.max(0,i-period+1), i+1);
      const mean = m;
      const variance = win.reduce((s,v)=>s+Math.pow(v-mean,2),0)/win.length;
      const sd = Math.sqrt(variance);
      outU.push({ time: bars[i].time, value: mean + mult*sd });
      outM.push({ time: bars[i].time, value: mean });
      outL.push({ time: bars[i].time, value: mean - mult*sd });
    }
    return { upper: outU.filter(Boolean), middle: outM.filter(Boolean), lower: outL.filter(Boolean) };
  }

  // --- Resampling (weekly/monthly) ---
  function resampleWeekly(daily){
    if (!daily.length) return [];
    const out=[]; let cur=null, wk=null;
    const isoWeek = (t)=>{ const d=new Date(t*1000); d.setUTCHours(0,0,0,0);
      const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day+3);
      const firstThu=new Date(Date.UTC(d.getUTCFullYear(),0,4));
      const week=1+Math.round(((d-firstThu)/86400000-3+((firstThu.getUTCDay()+6)%7))/7);
      return d.getUTCFullYear()+"-"+week; };
    for(const b of daily){ const w=isoWeek(b.time);
      if(w!==wk){ if(cur) out.push(cur); cur={...b}; wk=w; }
      else { cur.high=Math.max(cur.high,b.high); cur.low=Math.min(cur.low,b.low); cur.close=b.close; }
    } if(cur) out.push(cur); return out;
  }
  function resampleMonthly(daily){
    if (!daily.length) return [];
    const out=[]; let cur=null, key=null;
    const mKey=(t)=>{ const d=new Date(t*1000); return d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,'0'); };
    for(const b of daily){ const k=mKey(b.time);
      if(k!==key){ if(cur) out.push(cur); cur={...b}; key=k; }
      else { cur.high=Math.max(cur.high,b.high); cur.low=Math.min(cur.low,b.low); cur.close=b.close; }
    } if(cur) out.push(cur); return out;
  }

  // --- Drawings: Levels ---
  function refreshLevelsPanel(){
    const box=$('#levels'); box.innerHTML='';
    levels.forEach((lv, idx)=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`<span>${lv.price.toFixed(2)}</span>`;
      const del=document.createElement('button'); del.className='kill'; del.textContent='‚úï';
      del.onclick=()=>{ levels.splice(idx,1); saveLevels(currentSymbol,currentTF,levels); drawLevels(); refreshLevelsPanel(); };
      row.appendChild(del); box.appendChild(row);
    });
  }
  function drawLevels(){
    // remove old lines
    priceLines.forEach(pl=>{ try{candle.removePriceLine(pl);}catch{} });
    priceLines=[];
    // add current
    levels.forEach(lv=>{
      const line=candle.createPriceLine({
        price:lv.price, color:lv.color||'#60a5fa', lineWidth:2,
        lineStyle:LightweightCharts.LineStyle.Dashed, axisLabelVisible:true, title:`${lv.price.toFixed(2)}`
      });
      priceLines.push(line);
    });
  }
  function addLevel(price){
    levels.push({ id:'L'+Date.now(), price, color:'#60a5fa' });
    saveLevels(currentSymbol,currentTF,levels);
    drawLevels(); refreshLevelsPanel();
  }

  // --- Drawings: Trendlines ---
  function refreshTrendsPanel(){
    const box=$('#trends'); box.innerHTML='';
    trends.forEach((tr, idx)=>{
      const row=document.createElement('div'); row.className='row';
      const t1=new Date(tr.startTime*1000).toISOString().slice(0,10);
      const t2=new Date(tr.endTime*1000).toISOString().slice(0,10);
      row.innerHTML=`<span>${t1} ‚Üí ${t2}</span>`;
      const del=document.createElement('button'); del.className='kill'; del.textContent='‚úï';
      del.onclick=()=>{ trends.splice(idx,1); saveTrends(currentSymbol,currentTF,trends); drawTrends(); refreshTrendsPanel(); };
      row.appendChild(del); box.appendChild(row);
    });
  }
  function drawTrends(){
    trendSeries.forEach(s=>{ try{chart.removeSeries(s);}catch{} });
    trendSeries=[];
    trends.forEach(tr=>{
      const s=chart.addLineSeries({ color: tr.color||'#f59e0b', lineWidth:2 });
      s.setData([{time:tr.startTime, value:tr.startPrice},{time:tr.endTime, value:tr.endPrice}]);
      trendSeries.push(s);
    });
  }
  function addTrend(start, end){
    trends.push({ id:'T'+Date.now(), startTime:start.time, startPrice:start.price, endTime:end.time, endPrice:end.price, color:'#f59e0b' });
    saveTrends(currentSymbol,currentTF,trends);
    drawTrends(); refreshTrendsPanel();
  }

  // --- Cross logic ---
  function crossed(prevA, prevB, curA, curB){
    if ([prevA,prevB,curA,curB].some(v=>!Number.isFinite(v))) return false;
    const d1=prevA-prevB, d2=curA-curB;
    return (d1>0 && d2<0) || (d1<0 && d2>0);
  }
  function valueOnTrendAt(tr, t){
    if (tr.endTime===tr.startTime) return tr.startPrice;
    const m=(tr.endPrice-tr.startPrice)/(tr.endTime-tr.startTime);
    return tr.startPrice + m*(t-tr.startTime);
  }
  function evaluateCrosses(bars, emaArr){
    const out={ chips:[] };
    if (bars.length<2) return out;
    const b2=bars[bars.length-2], b1=bars[bars.length-1];

    // EMA200
    if (emaOn && emaArr?.length>=2){
      const e2=emaArr[emaArr.length-2].value, e1=emaArr[emaArr.length-1].value;
      if (crossed(b2.close, e2, b1.close, e1)) {
        out.chips.push( (b1.close>e1) ? chip('EMA200 ‚Üë','good') : chip('EMA200 ‚Üì','bad') );
      } else {
        out.chips.push( (b1.close>=e1) ? chip('Above EMA200','good') : chip('Below EMA200','bad') );
      }
    }

    // Levels
    const nearBps = 30; // 0.30%
    levels.forEach(lv=>{
      if (crossed(b2.close, lv.price, b1.close, lv.price)){
        out.chips.push( (b1.close>lv.price) ? chip(`Level ${lv.price.toFixed(2)} ‚Üë`,'good') : chip(`Level ${lv.price.toFixed(2)} ‚Üì`,'bad') );
      } else {
        const dist = Math.abs(b1.close - lv.price)/lv.price*10000; // bps
        if (dist <= nearBps) out.chips.push(chip(`Near ${lv.price.toFixed(2)} (${dist.toFixed(0)}bps)`,'warn'));
      }
    });

    // Trendlines
    trends.forEach(tr=>{
      const y2=valueOnTrendAt(tr, b2.time), y1=valueOnTrendAt(tr, b1.time);
      if (Number.isFinite(y2)&&Number.isFinite(y1) && crossed(b2.close,y2,b1.close,y1)){
        out.chips.push( (b1.close>y1) ? chip('Trend ‚Üë','good') : chip('Trend ‚Üì','bad') );
      }
    });

    return out;
  }
  function renderChips(out){
    const box=$('#chips'); box.innerHTML=''; out.chips.forEach(c=>box.appendChild(c));
  }

  // --- Fetch data ---
  async function fetchBars(symbol, days=4000){
    const r = await fetch(`${API}/eod?symbol=${encodeURIComponent(symbol)}&days=${days}`);
    if (!r.ok){ const t=await r.text(); log(`HTTP ${r.status}\n${t}`); return []; }
    const j = await r.json();
    return j.data || [];
  }

  // --- TF management ---
  function applyTF(tf, firstLoad=false){
    if (!chart || !candle) {
      console.error('[EOD] Chart not initialized - cannot apply timeframe');
      return;
    }
    
    currentTF = tf;
    let bars = dailyBars;
    if (tf==='1W') bars = resampleWeekly(dailyBars);
    else if (tf==='1M') bars = resampleMonthly(dailyBars);
    else if (tf==='4H') { console.warn('4H requires intraday. Showing daily until intraday endpoint is added.'); bars = dailyBars; }

    tfBars = bars;
    candle.setData(bars);

    // indicators
    let emaArr = [];
    if (emaOn && emaSeries){
      emaArr = emaFromBars(bars,200);
      emaSeries.setData(emaArr);
    } else if (emaSeries) {
      emaSeries.setData([]);
    }

    // redraw drawings for this sym+tf
    levels = loadLevels(currentSymbol,currentTF);
    trends = loadTrends(currentSymbol,currentTF);
    drawLevels(); refreshLevelsPanel();
    drawTrends(); refreshTrendsPanel();

    if (chart && chart.timeScale) {
      chart.timeScale().fitContent();
    }

    // chips
    renderChips(evaluateCrosses(bars, emaArr));
    if (!firstLoad) $('#topStatus').textContent = `${currentSymbol} ¬∑ ${currentTF}`;
  }

  async function loadSymbol(sym){
    currentSymbol = sym.toUpperCase();
    $('#topStatus').textContent = `Loading ${currentSymbol}‚Ä¶`;
    const bars = await fetchBars(currentSymbol, 4000);
    if (!bars.length){ log('No data'); return; }
    dailyBars = bars;
    applyTF(currentTF, true);
    $('#topStatus').textContent = `${currentSymbol} ¬∑ ${currentTF} ¬∑ ${bars.length} bars`;
  }

  // --- Tools wiring ---
  $('#btnLoad').onclick = ()=> loadSymbol($('#ticker').value.trim()||'AAPL');
  $$('.tf').forEach(b=>b.addEventListener('click', ()=>{
    $$('.tf').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    applyTF(b.dataset.tf);
  }));
  $('#toggleEMA').onclick = ()=>{ emaOn=!emaOn; $('#toggleEMA').classList.toggle('active', emaOn); applyTF(currentTF); };

  // Levels: click to add at mouse
  $('#toolLevel').onclick = ()=>{
    const active = !$('#toolLevel').classList.contains('active');
    drawingMode = active; drawingTool = active?'level':null; trendStart=null;
    $('#toolLevel').classList.toggle('active', active);
    $('#toolTrend').classList.remove('active');
    $('#topStatus').textContent = active? 'Click chart to place a level' : 'Ready';
  };

  // Trendlines: two clicks
  $('#toolTrend').onclick = ()=>{
    const active = !$('#toolTrend').classList.contains('active');
    drawingMode = active; drawingTool = active?'trendline':null; trendStart=null;
    $('#toolTrend').classList.toggle('active', active);
    $('#toolLevel').classList.remove('active');
    $('#topStatus').textContent = active? 'Click first point' : 'Ready';
  };

  chart.subscribeClick((p)=>{
    if (!drawingMode || !p?.point) return;
    const price = candle.coordinateToPrice(p.point.y);
    const time  = chart.timeScale().coordinateToTime(p.point.x);
    if (!Number.isFinite(price) || time==null) return;

    if (drawingTool==='level'){
      addLevel(price);
      drawingMode=false; $('#toolLevel').classList.remove('active'); $('#topStatus').textContent='Level added';
    } else if (drawingTool==='trendline'){
      if (!trendStart){ trendStart={time,price}; $('#topStatus').textContent='First set. Click second point.'; }
      else { addTrend(trendStart,{time,price}); trendStart=null; drawingMode=false; $('#toolTrend').classList.remove('active'); $('#topStatus').textContent='Trendline added'; }
    }
  });

  // --- Board (10 minis + enlarge) ---
  async function buildBoard(symbols=DEFAULT_WATCHLIST){
    const grid = $('#board-grid'); grid.innerHTML='';
    for (const sym of symbols.slice(0,10)){
      const cell = document.createElement('div'); cell.className='mini';
      const title = document.createElement('div'); title.className='title'; title.textContent=sym;
      const canvas = document.createElement('div'); canvas.style.position='absolute'; canvas.style.left=0; canvas.style.right=0; canvas.style.bottom=0; canvas.style.top='20px';
      const enlarge = document.createElement('button'); enlarge.className='enlarge'; enlarge.textContent='‚§¢';
      cell.append(title, canvas, enlarge); grid.appendChild(cell);

      const mini = LightweightCharts.createChart(canvas,{
        layout:{ background:{ color:'#0f1b2b' }, textColor:'#cbd5e1' },
        rightPriceScale:{ borderVisible:false }, timeScale:{ borderVisible:false },
        grid:{ vertLines:{ color:'#0f1b2b' }, horzLines:{ color:'#0f1b2b' } }
      });
      const s = mini.addCandlestickSeries({ upColor:'#4ade80', downColor:'#ef4444', borderVisible:false, wickUpColor:'#4ade80', wickDownColor:'#ef4444' });
      fetchBars(sym, 800).then(b=>{ s.setData(b.slice(-260)); mini.timeScale().fitContent(); });

      canvas.onclick = ()=>loadSymbol(sym);
      enlarge.onclick = ()=>openModal(sym);
    }
  }

  function openModal(sym){
    const modal=$('#modal'); const host=$('#modalCanvas');
    host.innerHTML=''; modal.style.display='flex';
    const big = LightweightCharts.createChart(host,{
      layout:{ background:{ color:'#0f1b2b' }, textColor:'#cbd5e1' },
      rightPriceScale:{ borderVisible:false }, timeScale:{ borderVisible:false }
    });
    const s = big.addCandlestickSeries();
    fetchBars(sym, 2000).then(b=>{ s.setData(b); big.timeScale().fitContent(); });
    $('#modal .close').onclick = ()=>{ modal.style.display='none'; big.remove(); };
  }

  // --- Event handlers ---
  function setupEventHandlers() {
    $('#btnLoad').onclick = () => {
      const sym = $('#ticker').value.trim().toUpperCase();
      if (sym) loadSymbol(sym);
    };
    
    $('#ticker').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const sym = $('#ticker').value.trim().toUpperCase();
        if (sym) loadSymbol(sym);
      }
    });
    
    // Timeframe buttons
    $$('.tf').forEach(btn => {
      btn.onclick = () => {
        $$('.tf').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTF = btn.dataset.tf;
        loadSymbol(currentSymbol);
      };
    });
    
    // Drawing tools
    $('#toolLevel').onclick = () => {
      const btn = $('#toolLevel');
      if (drawingMode && drawingTool === 'level') {
        drawingMode = false;
        drawingTool = null;
        btn.classList.remove('active');
        log('‚ùå Level tool deactivated');
      } else {
        drawingMode = true;
        drawingTool = 'level';
        trendStart = null;
        btn.classList.add('active');
        $('#toolTrend').classList.remove('active');
        log('üéØ Click on chart to add horizontal level');
      }
    };
    
    $('#toolTrend').onclick = () => {
      const btn = $('#toolTrend');
      if (drawingMode && drawingTool === 'trendline') {
        drawingMode = false;
        drawingTool = null;
        trendStart = null;
        btn.classList.remove('active');
        log('‚ùå Trendline tool deactivated');
      } else {
        drawingMode = true;
        drawingTool = 'trendline';
        trendStart = null;
        btn.classList.add('active');
        $('#toolLevel').classList.remove('active');
        log('üìà Click two points to draw trendline');
      }
    };
    
    // EMA toggle
    $('#toggleEMA').onclick = () => {
      emaOn = !emaOn;
      $('#toggleEMA').classList.toggle('active', emaOn);
      if (emaOn && emaSeries) {
        const ema = emaFromBars(tfBars);
        emaSeries.setData(ema);
        log('‚úÖ EMA200 enabled');
      } else if (emaSeries) {
        emaSeries.setData([]);
        log('‚ùå EMA200 disabled');
      } else {
        log('‚ùå Chart not initialized - cannot toggle EMA');
      }
    };
  }

  // --- Boot ---
  function initialize() {
    console.log('[EOD] Starting initialize function');
    
    // Basic environment checks
    console.log('[EOD] LightweightCharts available:', typeof LightweightCharts !== 'undefined');
    console.log('[EOD] Chart container exists:', !!$('#chart'));
    console.log('[EOD] Log element exists:', !!$('#log'));
    
    try {
      log('üîÑ Starting initialization...');
      fetch(`${API}/healthz`).then(r=>r.ok?log('Backend OK'):log('Backend NOT OK')).catch(e=>log('Backend error: '+e.message));
      
      log('üìä Initializing chart...');
      const chartResult = initChart();
      log(`üìä Chart init result: ${chartResult}`);
      
      if (!chartResult) {
        log('‚ùå Chart initialization failed - stopping');
        return;
      }
      
      log('üéõÔ∏è Setting up event handlers...');
      setupEventHandlers();
      
      log('üìã Building board...');
      buildBoard();
      
      log('üìà Loading default symbol...');
      loadSymbol('AAPL');
      
      log('üöÄ EOD Watch initialized');
    } catch (error) {
      console.error('[EOD] Error in initialize:', error);
      log('‚ùå Initialization failed: ' + error.message);
    }
  }
  
  // Wait for DOM to be ready
  console.log('[EOD] Document ready state:', document.readyState);
  
  try {
    if (document.readyState === 'loading') {
      console.log('[EOD] Adding DOMContentLoaded listener');
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      console.log('[EOD] DOM already ready, calling initialize directly');
      initialize();
    }
  } catch (error) {
    console.error('[EOD] Error in startup:', error);
  }
})();
</script>
</body>
</html>
